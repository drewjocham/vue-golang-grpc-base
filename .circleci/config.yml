# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  api:
    working_directory: ~/api
    docker:
      - image: cimg/go:1.19
    steps:
        - checkout:
              path: ~/api
        -   setup_remote_docker: # (2)
                docker_layer_caching: true # (3)
        - run: cd api && ls -all
        - run: cd api && go get -v -t -d ./...
        - run: cd api && go build -o main .
        -   deploy:
                docker:
                - image: docker:18.09-git
                  auth:
                      username: $DOCKER_PASS
                      password: $DOCKER_PASS
                command: |
                    if [ "${CIRCLE_BRANCH}" == "circle-ci-adjustment" ]; then
                      cd api && docker build -t drewjocham/api:v1 .
                      docker push drewjocham/api:v1
                    fi
  client:
    working_directory: ~/client
    # docker login -u ${DOCKER_USER} -p ${DOCKER_PASS} https://index.docker.io/v1/
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    docker:
      - image: cimg/node:16.18.1
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
        - checkout:
              path: ~/client
       # - restore_cache:
       #       name: Restore Yarn Package Cache
       #       keys:
       #           - yarn-packages-{{ checksum "yarn.lock" }}
        -   setup_remote_docker:
                docker_layer_caching: true
                version: 20.10.14
        - run:
              name: Install Dependencies
              command: cd client && yarn install --immutable
        #- save_cache:
        #      name: Save Yarn Package Cache
        #      key: cd client && yarn-packages-{{ checksum "yarn.lock" }}
        #      paths:
        #          - .yarn/cache
        #          - .yarn/unplugged
        - run: cd client && yarn build
        -   deploy:
                docker:
                - image: docker:18.09-git
                  auth:
                      username: $DOCKER_USER
                      password: $DOCKER_PASS
                command: |
                    if [ "${CIRCLE_BRANCH}" == "circle-ci-adjustment" ]; then
                      cd client && docker build -t drewjocham/client:v1 .
                      docker push drewjocham/client:v1
                    fi

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
    hobby-project-setup:
        jobs:
          - client:
              context: docker # env context name
          - api:
              context: docker
        #build:
          #machine:
          #image: ubuntu-2004:202008-01



